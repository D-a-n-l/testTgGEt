<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL | DeepLift</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="unity-container" style="position: absolute; width: 100%; height: 100%; left: 0%; top: 0%;">
        <canvas id="unity-canvas" style="position: absolute; width: 100%; height: 100%"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"> </div>
    </div>

    <script>
        window.onload = function () {
            var tg = window.Telegram.WebApp;
            if (!tg) {
                console.error("Telegram WebApp API не загрузился!");
                return;
            }

            tg.expand(); // Разворачиваем Web App на весь экран

            function sendUserDataToUnity(unityInstance) {
                let user = tg.initDataUnsafe.user;
                if (!user) {
                    console.error("Не удалось получить данные пользователя Telegram!");
                    return;
                }

                let userData = {
                    id: user.id,
                    first_name: user.first_name,
                    last_name: user.last_name || "",
                    username: user.username || "",
                    language: user.language_code
                };

                // Отправка данных в Unity
                unityInstance.SendMessage("TelegramManager", "OnTelegramDataReceived", JSON.stringify(userData));
            }

            var canvas = document.querySelector("#unity-canvas");

            var buildUrl = "Build";
            var loaderUrl = buildUrl + "/TestTgGet.loader.js";
            var config = {
                arguments: [],
                dataUrl: buildUrl + "/TestTgGet.data",
                frameworkUrl: buildUrl + "/TestTgGet.framework.js",
                codeUrl: buildUrl + "/TestTgGet.wasm",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "Dvelop",
                productName: "DeepLift",
                productVersion: "1.01",
            };

            var script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
                }).then((unityInstance) => {
                    document.querySelector("#unity-loading-bar").style.display = "none";
                    sendUserDataToUnity(unityInstance);
                }).catch((message) => {
                    console.error("Ошибка Unity: ", message);
                });
            };

            document.body.appendChild(script);
        };
    </script>
</body>
</html>